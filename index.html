<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube 再生数ランキング & トレンド ダッシュボード</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* 前回のデザインをベースに調整したスタイル（ダーク） */
    :root{
      --bg:#071022; --card:#0b1220; --muted:#9aa7bf; --accent:#6ee7b7;
      --glass: rgba(255,255,255,0.03); --card-radius:12px;
      font-family: Inter, system-ui, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
      color: #e6eef8;
    }
    html,body{height:100%; margin:0; background:linear-gradient(180deg,#071024 0%, #071226 60%); color:var(--muted);}
    .wrap{max-width:1200px;margin:28px auto;padding:20px;}
    header{display:flex;gap:18px;align-items:center;justify-content:space-between;margin-bottom:18px;}
    header .title{font-size:20px;color:#fff;}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .card{background:var(--card);border-radius:var(--card-radius);padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    .grid{display:grid;grid-template-columns: 340px 1fr;gap:16px;}
    select, button, input[type="search"]{
      background:var(--glass); border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px;border-radius:8px;
    }
    button.primary{background:linear-gradient(90deg,#3dd598,#2bb2ff); color:#021; font-weight:700; border:none;}
    .rank-list{display:flex;flex-direction:column;gap:8px; max-height:520px; overflow:auto; padding-right:6px;}
    .video-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer;transition:background .12s}
    .video-item:hover{background:rgba(255,255,255,0.02)}
    .thumb{width:84px;height:48px;border-radius:8px;background:#222;flex:0 0 84px;object-fit:cover;}
    .meta{flex:1;min-width:0;}
    .meta .title{font-size:13px;color:#eaf6ff;font-weight:600;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;}
    .meta .sub{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:rgba(255,255,255,0.03);color:var(--muted)}
    .rank-num{font-size:14px;color:#a6d6ff;width:28px;text-align:center}
    .stats-row{display:flex;gap:8px;align-items:center; justify-content:flex-end;}
    .big-card{padding:16px;}
    .chart-area{height:320px;}
    .tabs{display:flex;gap:8px;margin-bottom:12px;}
    .tabs button{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer;}
    .tabs button.active{background:linear-gradient(90deg,#0b2540,#01324a); color:#fff;border-color:transparent;}
    .top-metrics{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .metric{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px;border-radius:10px; min-width:150px;}
    .metric .val{font-size:18px;color:#fff;font-weight:700}
    .footer-note{font-size:12px;color:var(--muted);margin-top:8px}
    .last-updated{font-size:13px;color:var(--muted);margin-top:6px}
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">YouTube 再生数ランキング & トレンド</div>
        <div class="subtitle" style="font-size:13px;color:var(--muted)">GitHub Pages + GitHub Actions で日次更新される静的ダッシュボード</div>
        <div id="lastUpdated" class="last-updated">最終更新: —</div>
      </div>
      <div class="controls">
        <input id="search" type="search" placeholder="タイトル / バナー / ユニット で検索">
        <select id="scope">
          <option value="all">全体</option>
          <option value="banner">バナー別</option>
          <option value="unit">ユニット別</option>
        </select>
        <select id="groupFilter"><option value="all">グループ: 全て</option></select>
        <button id="reload" class="primary">データを再読み込み</button>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <strong style="color:#fff">ランキング</strong>
            <div style="font-size:13px;color:var(--muted)">並び替え:
              <select id="sortMode">
                <option value="total">累計再生数（降順）</option>
                <option value="week">直近7日増分（降順）</option>
                <option value="month">直近30日増分（降順）</option>
              </select>
            </div>
          </div>

          <div class="top-metrics" style="margin-top:10px;">
            <div class="metric card">
              <div style="font-size:12px;color:var(--muted)">総再生数トップ</div>
              <div id="topTotal" class="val">—</div>
            </div>
            <div class="metric card">
              <div style="font-size:12px;color:var(--muted)">1週間伸びトップ</div>
              <div id="topWeek" class="val">—</div>
            </div>
            <div class="metric card">
              <div style="font-size:12px;color:var(--muted)">1ヶ月伸びトップ</div>
              <div id="topMonth" class="val">—</div>
            </div>
          </div>

          <div style="margin-top:12px;" class="rank-list card" id="rankList">
            読み込み中...
          </div>
          <div class="footer-note">※ サムネイルをクリックすると右側でグラフ表示します。データは `data/videos.json` から読み込まれます。</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <strong style="color:#fff">集計切り口</strong>
          <div style="margin-top:8px;" class="filter-row">
            <button id="btnAll" class="tabBtn">全体</button>
            <button id="btnBanner" class="tabBtn">バナー別</button>
            <button id="btnUnit" class="tabBtn">ユニット別</button>
          </div>
          <div style="margin-top:10px;color:var(--muted);font-size:13px">
            ・動画の一覧・バナー・ユニットは `videos_list.json` で管理します。<br>
            ・ワークフローが日次で `data/videos.json` を更新します。
          </div>
        </div>
      </div>

      <div>
        <div class="card big-card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div id="selectedTitle" style="font-weight:700;font-size:16px;color:#eaf6ff">（動画を選択してください）</div>
              <div id="selectedMeta" style="font-size:13px;color:var(--muted);margin-top:6px">—</div>
            </div>
            <div class="stats-row">
              <div style="text-align:right">
                <div style="font-size:12px;color:var(--muted)">最新再生数</div>
                <div id="selectedViews" style="font-weight:800;font-size:18px;color:#fff">—</div>
              </div>
            </div>
          </div>

          <div style="margin-top:14px;" class="tabs">
            <button class="tab-mode active" data-period="all">全期間推移</button>
            <button class="tab-mode" data-period="30">直近30日</button>
            <button class="tab-mode" data-period="7">直近7日</button>
          </div>

          <div class="chart-area card" style="padding:12px;">
            <canvas id="trendChart" style="width:100%;height:320px"></canvas>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;">
            <div class="metric card" style="min-width:180px;">
              <div style="font-size:12px;color:var(--muted)">直近7日増分</div>
              <div id="viewDelta7" class="val">—</div>
            </div>
            <div class="metric card" style="min-width:180px;">
              <div style="font-size:12px;color:var(--muted)">直近30日増分</div>
              <div id="viewDelta30" class="val">—</div>
            </div>
            <div class="metric card" style="min-width:180px;">
              <div style="font-size:12px;color:var(--muted)">投稿日</div>
              <div id="publishDate" class="val">—</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <strong style="color:#fff">注記 / 操作</strong>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">
            ・`data/videos.json` は GitHub Actions によって更新されます。<br>
            ・ワークフローの実行ログは GitHub Actions ページで確認してください。<br>
            ・初回はワークフローを手動実行して `data/videos.json` を作成してください。
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* --- helper --- */
function fmt(n){ return n === null || n === undefined ? '—' : n.toLocaleString(); }
function safe(s){ return String(s||''); }

/* --- load data/videos.json --- */
let DATA = [];
async function loadData(){
  try{
    const res = await fetch('/data/videos.json', {cache: "no-store"});
    if(!res.ok) throw new Error('data/videos.json が見つかりません: ' + res.status);
    const json = await res.json();
    DATA = json.videos || [];

    // 最終更新日時を表示（updated_at を使用）
    const lastEl = document.getElementById('lastUpdated');
    if(json.updated_at){
      try{
        const d = new Date(json.updated_at);
        // 日本語ロケールで表示（環境に依存するが一般的に見やすい形式）
        lastEl.innerText = '最終更新: ' + d.toLocaleString('ja-JP');
      }catch(e){
        lastEl.innerText = '最終更新: ' + json.updated_at;
      }
    } else {
      lastEl.innerText = '最終更新: —';
    }

    buildGroupOptions();
    renderRankList();
    selectDefault();
  }catch(err){
    console.error(err);
    document.getElementById('rankList').innerText = 'データ読み込みエラー: ' + err.message;
    document.getElementById('lastUpdated').innerText = '最終更新: —';
  }
}

/* --- UI state and utilities --- */
const rankListEl = document.getElementById('rankList');
const sortModeEl = document.getElementById('sortMode');
const searchEl = document.getElementById('search');
const scopeEl = document.getElementById('scope');
const groupFilterEl = document.getElementById('groupFilter');
const reloadBtn = document.getElementById('reload');

function buildGroupOptions(){
  const banners = Array.from(new Set(DATA.map(v=>v.banner))).sort();
  const units = Array.from(new Set(DATA.map(v=>v.unit))).sort();
  groupFilterEl.innerHTML = '<option value="all">グループ: 全て</option>';
  if(scopeEl.value === 'banner'){
    banners.forEach(b=> groupFilterEl.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`));
  } else if(scopeEl.value === 'unit'){
    units.forEach(u=> groupFilterEl.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`));
  } else {
    groupFilterEl.insertAdjacentHTML('beforeend','<option disabled>--- バナー ---</option>');
    banners.forEach(b=> groupFilterEl.insertAdjacentHTML('beforeend', `<option value="banner:${escapeHtml(b)}">${escapeHtml(b)}</option>`));
    groupFilterEl.insertAdjacentHTML('beforeend','<option disabled>--- ユニット ---</option>');
    units.forEach(u=> groupFilterEl.insertAdjacentHTML('beforeend', `<option value="unit:${escapeHtml(u)}">${escapeHtml(u)}</option>`));
  }
}

function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* --- compute delta (history must be array of {date, views} ascending) --- */
function calcDelta(history, days){
  if(!history || history.length===0) return 0;
  const last = history[history.length-1];
  const lastDate = new Date(last.date);
  const startDate = new Date(lastDate);
  startDate.setDate(lastDate.getDate() - days);
  let startRec = history[0];
  for(const rec of history){
    const d = new Date(rec.date);
    if(d <= startDate) startRec = rec;
    else break;
  }
  return last.views - startRec.views;
}

/* --- render ranking --- */
function renderRankList(){
  const mode = sortModeEl.value;
  const q = searchEl.value.trim().toLowerCase();
  let list = DATA.slice();

  const gv = groupFilterEl.value;
  if(gv && gv !== 'all'){
    if(gv.startsWith('banner:')) list = list.filter(v=>v.banner === gv.slice(7));
    else if(gv.startsWith('unit:')) list = list.filter(v=>v.unit === gv.slice(5));
    else {
      if(scopeEl.value === 'banner') list = list.filter(v=>v.banner === gv);
      if(scopeEl.value === 'unit') list = list.filter(v=>v.unit === gv);
    }
  }

  if(q) list = list.filter(v=>{
    return (v.title||'').toLowerCase().includes(q) || (v.banner||'').toLowerCase().includes(q) || (v.unit||'').toLowerCase().includes(q);
  });

  const annotated = list.map(v=>{
    const latest = v.history && v.history.length ? v.history[v.history.length-1].views : (v.views || 0);
    const d7 = calcDelta(v.history, 7);
    const d30 = calcDelta(v.history, 30);
    return {...v, latest, d7, d30};
  });

  if(mode === 'total') annotated.sort((a,b)=>b.latest - a.latest);
  else if(mode === 'week') annotated.sort((a,b)=>b.d7 - a.d7);
  else annotated.sort((a,b)=>b.d30 - a.d30);

  document.getElementById('topTotal').innerText = annotated[0] ? `${annotated[0].title} — ${fmt(annotated[0].latest)} 回` : '—';
  const topWeek = annotated.reduce((acc,cur)=> cur.d7 > (acc.d7||-Infinity) ? cur : acc, {});
  const topMonth = annotated.reduce((acc,cur)=> cur.d30 > (acc.d30||-Infinity) ? cur : acc, {});
  document.getElementById('topWeek').innerText = (topWeek && topWeek.title) ? `${topWeek.title} — ${fmt(topWeek.d7)} 回` : '—';
  document.getElementById('topMonth').innerText = (topMonth && topMonth.title) ? `${topMonth.title} — ${fmt(topMonth.d30)} 回` : '—';

  rankListEl.innerHTML = '';
  annotated.forEach((v, idx)=>{
    const li = document.createElement('div');
    li.className = 'video-item';
    li.innerHTML = `
      <div class="rank-num">${idx+1}</div>
      <img class="thumb" src="${escapeHtml(v.thumbnail)}" alt="thumb">
      <div class="meta">
        <div class="title">${escapeHtml(v.title)}</div>
        <div class="sub">
          <div class="badge">${escapeHtml(v.banner)}</div>
          <div class="badge">${escapeHtml(v.unit)}</div>
          <div style="margin-left:auto;color:var(--muted)">${fmt(v.latest)} 回</div>
          <div style="color:var(--muted);font-size:12px">▲${fmt(v.d7)} / 7d</div>
        </div>
      </div>
    `;
    li.addEventListener('click', ()=> selectVideo(v));
    rankListEl.appendChild(li);
  });
}

/* --- chart & selection --- */
let currentSelected = null;
const ctx = document.getElementById('trendChart').getContext('2d');
let chart = null;

function selectVideo(v){
  currentSelected = v;
  document.getElementById('selectedTitle').innerText = v.title;
  document.getElementById('selectedMeta').innerHTML = `${v.banner} ・ ${v.unit} ・ <a href="${v.url}" target="_blank" style="color:var(--accent)">YouTubeへ</a>`;
  document.getElementById('selectedViews').innerText = fmt(v.history && v.history.length ? v.history[v.history.length-1].views : v.views) + ' 回';
  document.getElementById('viewDelta7').innerText = fmt(calcDelta(v.history,7)) + ' 回';
  document.getElementById('viewDelta30').innerText = fmt(calcDelta(v.history,30)) + ' 回';
  document.getElementById('publishDate').innerText = v.published || '—';
  drawChartForSelection('all');
}

function drawChartForSelection(period){
  if(!currentSelected) return;
  const hist = currentSelected.history || [];
  if(hist.length === 0) {
    if(chart){ chart.destroy(); chart = null; }
    ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
    return;
  }
  let points = hist.slice();
  if(period === '7') points = hist.slice(Math.max(0, hist.length - 7));
  else if(period === '30') points = hist.slice(Math.max(0, hist.length - 30));

  const labels = points.map(p=>p.date);
  const data = points.map(p=>p.views);

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: currentSelected.title, data, tension:0.2, fill:true, backgroundColor: 'rgba(59,130,246,0.06)', borderColor:'rgba(59,130,246,0.9)', pointRadius:3 }]},
    options: {
      responsive:true, maintainAspectRatio:false,
      scales: {
        x: { display:true, grid:{color:'rgba(255,255,255,0.03)'}, ticks:{ color:'#9fb4d2' } },
        y: { display:true, grid:{color:'rgba(255,255,255,0.03)'}, ticks:{ color:'#9fb4d2', callback: v => Intl.NumberFormat().format(v) } }
      },
      plugins: { legend:{display:false}, tooltip:{ callbacks: { label: ctx => `${Intl.NumberFormat().format(ctx.parsed.y)} 回` } } }
    }
  });
}

/* --- event binding --- */
document.getElementById('reload').addEventListener('click', loadData);
sortModeEl.addEventListener('change', renderRankList);
searchEl.addEventListener('input', renderRankList);
scopeEl.addEventListener('change', ()=>{ buildGroupOptions(); renderRankList(); });
groupFilterEl.addEventListener('change', renderRankList);
document.getElementById('btnAll').addEventListener('click', ()=> { scopeEl.value='all'; buildGroupOptions(); renderRankList(); });
document.getElementById('btnBanner').addEventListener('click', ()=> { scopeEl.value='banner'; buildGroupOptions(); renderRankList(); });
document.getElementById('btnUnit').addEventListener('click', ()=> { scopeEl.value='unit'; buildGroupOptions(); renderRankList(); });
document.querySelectorAll('.tab-mode').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-mode').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    drawChartForSelection(btn.dataset.period);
  });
});

/* --- default select --- */
function selectDefault(){
  if(DATA.length) {
    // 最新の累計が多い順で最初の1つを選ぶ
    const sorted = DATA.slice().sort((a,b)=> {
      const la = a.history && a.history.length ? a.history[a.history.length-1].views : (a.views||0);
      const lb = b.history && b.history.length ? b.history[b.history.length-1].views : (b.views||0);
      return lb - la;
    });
    selectVideo(sorted[0]);
  }
}

/* --- initial load --- */
loadData();
</script>
</body>
</html>
